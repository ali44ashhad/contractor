# Construction Management System - Project Context

## Overview

This is a construction project management system built with TypeScript, Express, and MongoDB. The system manages construction projects, teams, contractors, daily updates, attendance tracking, and project completion/extension requests.

## Models and Relationships

### User Model
- **Purpose**: Manages user accounts with authentication
- **Roles**: `ADMIN`, `CONTRACTOR`, `ACCOUNTS`, `DEVELOPER`, `MEMBER`
- **Key Fields**: `email`, `password` (hashed), `name`, `role`, `phone`, `isActive`
- **Relationships**: 
  - Referenced by: Project (adminId, contractorId), Team (contractorId, members, createdBy), Update (contractorId, postedBy), Attendance (userId), ProjectRequest (requestedBy, reviewedBy)

### Project Model
- **Purpose**: Represents construction projects
- **Status Values**: `PLANNING`, `IN_PROGRESS`, `ON_HOLD`, `COMPLETED`, `CANCELLED`
- **Key Fields**: `name`, `description`, `adminId`, `contractorId`, `status`, `startDate`, `endDate`, `budget`, `location`
- **Relationships**:
  - Created by: Admin (adminId)
  - Assigned to: Contractor (contractorId)
  - Has: Teams, Updates, Attendance records, ProjectRequests

### Team Model
- **Purpose**: Groups team members assigned to projects
- **Key Fields**: `projectId`, `contractorId`, `teamName`, `members[]`, `createdBy`
- **Relationships**:
  - Belongs to: Project (projectId)
  - Managed by: Contractor (contractorId)
  - Contains: Team members (members array)
  - Created by: Admin (createdBy)

### Update Model
- **Purpose**: Daily project updates with site photos (morning/evening)
- **Update Types**: `MORNING`, `EVENING`
- **Key Fields**: `projectId`, `contractorId`, `postedBy`, `updateType`, `status`, `updateDate`, `timestamp` (auto-logged), `updateDescription`, `documents[]`
- **Validation**: 
  - Requires at least one document/image
  - Max 2 updates per day per user (one morning, one evening)
  - Only allowed when project status is `IN_PROGRESS`
- **Relationships**:
  - Belongs to: Project (projectId)
  - Associated with: Contractor (contractorId)
  - Posted by: Team member (postedBy)
  - Linked to: Attendance records (morningUpdateId, eveningUpdateId)

### Attendance Model
- **Purpose**: Tracks daily attendance based on updates
- **Key Fields**: `userId`, `projectId`, `date`, `morningUpdateId`, `eveningUpdateId`, `isPresent` (derived)
- **Auto-populated**: Created/updated when updates are posted
- **Relationships**:
  - For: User (userId)
  - In: Project (projectId)
  - References: Update records (morningUpdateId, eveningUpdateId)

### ProjectRequest Model
- **Purpose**: Handles completion and extension requests
- **Request Types**: `COMPLETION`, `EXTENSION`
- **Request Status**: `PENDING`, `APPROVED`, `REJECTED`
- **Key Fields**: `projectId`, `requestedBy`, `type`, `status`, `requestedEndDate`, `approvedEndDate`, `reason`, `adminNotes`, `reviewedBy`, `reviewedAt`
- **Relationships**:
  - For: Project (projectId)
  - Requested by: Contractor (requestedBy)
  - Reviewed by: Admin (reviewedBy)

### Report Model
- **Purpose**: Reports generated by accounts users
- **Report Types**: `FINANCIAL`, `PROGRESS`, `SUMMARY`, `CUSTOM`
- **Key Fields**: `projectId` (optional), `generatedBy`, `type`, `title`, `data`, `filePath`, `description`

## Workflows

### Daily Update Workflow
1. **Prerequisites**: 
   - Project status must be `IN_PROGRESS`
   - User must be a team member (contractor or member of project team)
   
2. **Process**:
   - Team member posts update with `updateType` (MORNING or EVENING)
   - At least one image/document must be uploaded
   - Timestamp is auto-logged
   - System validates max 2 updates per day per user (one morning, one evening)
   - Attendance record is created/updated automatically

3. **Attendance Tracking**:
   - When morning update is posted → `morningUpdateId` set in attendance
   - When evening update is posted → `eveningUpdateId` set in attendance
   - `isPresent` is automatically set to `true` if at least one update exists

### Project Completion Workflow
1. **Contractor Action**:
   - Contractor marks project as completed → Creates completion request
   - Request status: `PENDING`
   
2. **Admin Review**:
   - Admin can approve → Project status changes to `COMPLETED`
   - Admin can reject → Project status goes back to `IN_PROGRESS`
   - Admin can add notes when approving/rejecting

### Project Extension Workflow
1. **Contractor Action**:
   - Contractor requests extension with new `requestedEndDate`
   - Request status: `PENDING`
   
2. **Admin Review**:
   - Admin can approve with optional duration modification (`approvedEndDate`)
   - Admin can reject → Project endDate unchanged
   - Project status stays `IN_PROGRESS` in both cases
   - Daily updates continue until project completes

## Business Rules and Validations

### Update Posting Rules
- **Frequency**: Maximum 2 updates per day per user per project (one morning, one evening)
- **Project Status**: Updates only allowed when project status is `IN_PROGRESS`
- **Team Membership**: User must be part of project team (contractor or team member)
- **Image Requirement**: At least one image/document required per update
- **Timestamp**: Auto-logged, no manual input allowed

### Project Status Rules
- **Status Changes**: Cannot change project status while pending requests exist
- **Completion**: Only via admin approval of completion request
- **Extension**: Only via admin approval of extension request

### Request Rules
- **One Pending Request**: Only one pending request per type per project allowed
- **Completion Request**: Can only be created for `IN_PROGRESS` projects
- **Extension Request**: `requestedEndDate` must be after current project `endDate`
- **Admin Modification**: Admin can modify extension duration when approving

### Attendance Rules
- **Auto-creation**: Attendance records created automatically when updates are posted
- **One Record Per Day**: One attendance record per user per project per day
- **Presence**: `isPresent` is `true` if at least one update (morning or evening) exists

## API Endpoints

### Authentication
- `POST /api/auth/register` - Register new user
- `POST /api/auth/login` - Login user
- `POST /api/auth/logout` - Logout user

### Users
- `GET /api/users` - Get all users (Admin only)
- `GET /api/users/:id` - Get user by ID
- `POST /api/users` - Create user (Admin only)
- `PATCH /api/users/:id` - Update user (Admin only)
- `DELETE /api/users/:id` - Delete user (Admin only)

### Projects
- `GET /api/projects` - Get all projects (filtered by role)
- `GET /api/projects/:id` - Get project by ID
- `POST /api/projects` - Create project (Admin only)
- `PATCH /api/projects/:id` - Update project (Admin only)
- `PATCH /api/projects/:id/assign` - Assign project to contractor (Admin only)
- `DELETE /api/projects/:id` - Delete project (Admin only)

### Teams
- `GET /api/teams` - Get all teams
- `GET /api/teams/:id` - Get team by ID
- `POST /api/teams` - Create team (Admin only)
- `PATCH /api/teams/:id` - Update team (Admin can update all, Contractor can update members)
- `PATCH /api/teams/:id/members` - Add team members (Admin only)
- `DELETE /api/teams/:id` - Delete team (Admin only)

### Updates
- `GET /api/updates` - Get all updates (filtered by role)
- `GET /api/updates/:id` - Get update by ID
- `POST /api/updates` - Create update (Team members only)
- `POST /api/updates/:id/documents` - Add documents to update (Team members, own updates only)

### Attendance
- `GET /api/attendance` - Get attendance records with filters
- `GET /api/attendance/user/:userId` - Get attendance for specific user
- `GET /api/attendance/project/:projectId` - Get attendance for project team members

### Requests
- `POST /api/requests/completion` - Create completion request (Contractor only)
- `POST /api/requests/extension` - Create extension request (Contractor only)
- `GET /api/requests` - Get requests (Contractors see own, Admins see all)
- `PATCH /api/requests/:id/approve` - Approve request (Admin only)
- `PATCH /api/requests/:id/reject` - Reject request (Admin only)

### Reports
- `GET /api/reports` - Get all reports
- `GET /api/reports/:id` - Get report by ID
- `POST /api/reports` - Create report (Accounts only)
- `DELETE /api/reports/:id` - Delete report (Accounts only)

## Permissions Matrix

| Action | Admin | Contractor | Member | Accounts |
|--------|-------|------------|--------|----------|
| Create Projects | ✅ | ❌ | ❌ | ❌ |
| Create Teams | ✅ | ❌ | ❌ | ❌ |
| Post Updates | ✅ | ✅ (own projects) | ✅ (team projects) | ❌ |
| Create Requests | ❌ | ✅ (own projects) | ❌ | ❌ |
| Approve/Reject Requests | ✅ | ❌ | ❌ | ❌ |
| View Attendance | ✅ (all) | ✅ (own projects) | ✅ (team projects) | ❌ |
| Generate Reports | ❌ | ❌ | ❌ | ✅ |
| Manage Users | ✅ | ❌ | ❌ | ❌ |

## Data Flow

### Update Creation Flow
```
User → POST /api/updates
  → Validate team membership
  → Validate project status (IN_PROGRESS)
  → Validate update frequency (max 2/day)
  → Validate image requirement
  → Create Update record
  → Create/Update Attendance record
  → Return populated Update
```

### Request Approval Flow
```
Contractor → POST /api/requests/completion
  → Create ProjectRequest (PENDING)
  → Admin → PATCH /api/requests/:id/approve
    → Update ProjectRequest (APPROVED)
    → Update Project status (COMPLETED)
  OR
  → Admin → PATCH /api/requests/:id/reject
    → Update ProjectRequest (REJECTED)
    → Update Project status (IN_PROGRESS)
```

## Indexes

### Update Model
- `projectId`, `contractorId`, `postedBy`, `updateDate`, `updateType`
- Unique: `(postedBy, projectId, updateDate, updateType)` - Prevents duplicate morning/evening updates

### Attendance Model
- `userId`, `projectId`, `date`
- Unique: `(userId, projectId, date)` - One record per user per project per day

### ProjectRequest Model
- `projectId`, `requestedBy`, `status`, `type`
- Composite: `(projectId, status)`, `(requestedBy, status)`

## Notes

- All timestamps are auto-logged (no manual input)
- Attendance is automatically derived from Update records
- Team membership validation required for all update operations
- Project status changes blocked when pending requests exist
- Password hashing uses bcrypt with salt rounds of 12
- JWT tokens stored in httpOnly cookies for security

